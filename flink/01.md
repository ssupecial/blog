
# Flink는 어떻게 내결함성을 보장하는가? (Checkpoint와 Savepoint 소개)

## Flink란?
Apache Flink는 실시간(스트리밍) 데이터를 계속 받아서 처리하는 분산 데이터 처리 엔진입니다.
Kafka, MQTT Broker 등과 같은 곳에서 들어오는 데이터를 흘러오는 대로 계산하고, 처리합니다.

### Flink에서 제일 중요한 개념은 "상태(state)다"
개인적으로 Flink에서 가장 중요한 개념은 상태라고 생각합니다.
Flink는 단순히 데이터를 처리하는 것이 아니라, 처리하면서 "기억"을 쌓습니다.

예를 들어, 다음과 같은 작업에선 상태가 중요합니다.
- “최근 5분 동안의 평균을 계산해라”
→ 5분이 끝날 때까지 값들을 계속 모아둬야 함(중간값/누적값을 기억)

- “사용자별로 클릭 수를 세어라”
→ 사용자마다 카운트를 계속 저장해둬야 함

- “이상징후가 3번 연속 나오면 경고해라”
→ 이전 이벤트들을 기억하고 있어야 함

위와 작업 같은 작업을 가능하게 할 뿐만 아니라, 상태를 기억하기 때문에 장애 복구/정확도 보장이 가능해집니다.
Flink는 장애가 발생해도 "없던 일처럼" 다시 이어서 처리할 수 있도록 체크포인트(Checkpoint)라는 안전장치를 둡니다.

### Flink 복구의 핵심은 "상태+어디까지 읽었는지"를 같이 맞추는 것
Flink가 장애에서 복구할 때 가장 중요한 건 딱 두 가지입니다.
1. 상태(state): 지금까지 계산하며 쌓아둔 기억(윈도우 중간 값, 집계 값 등)
2. 스트림 위치(stream position): 소스가 어디까지 읽었는지(예: Kafka 오프셋)

장애가 발생했을 때 이 둘이 서로 다른 시점을 가리키면 문제가 생깁니다.
- 상태는 “10시 05분까지 처리된 것”인데, 소스 위치는 “10시 03분까지”라면 → 이미 반영된 데이터를 다시 읽어 중복 처리가 됩니다.
- 상태는 “10시 03분까지”인데, 소스 위치는 “10시 05분까지”라면 → 이미 읽은 것으로 간주되어 누락이 됩니다.

그래서 Flink는 복구 시점에 “상태와 스트림 위치”가 서로 정합성을 갖도록 맞춰야 하고, 이를 위해 일관성 체크포인트(consistent checkpoint)를 사용합니다.

## 일관성 체크포인트란?
### 일관성의 정의: 동일한 논리 시점의 스냅샷
> 모든 태스크가 "동일한 시점"의 상태를 스냅샷으로 남겨, <br/>장애 시 그 시점으로 되돌아갈 수 있게 만든다.

여기서 "동일한 시점"은 물리적인 시계 시간이 아니라, 분산 실행 환경에서의 논리적 처리 진행도에 가깝습니다. 
즉, 2025년 12월 25일 14:39:55라는 시점이 아니라 어떤 레코드까지 처리되었는지(그리고 그에 따라 상태가 어떻게 바뀌었는지)를 태스크들 사이에서 일관되게 맞춘 스냅샷이 핵심입니다.

### 상태가 있는 애플리케이션에서 왜 중요한가
예를 들어 5분 단위 윈도우 집계를 한다고 가정해보면,
윈도우가 닫히기 전까지는 “누적 상태”가 오퍼레이터 내부에 유지됩니다.
장애가 나서 상태가 날아가면, 동일한 입력을 다시 읽더라도 “어디까지 집계가 반영됐는지”가 달라져 결과가 달라질 수 있습니다.
일관성 체크포인트는 이 문제를 해결하기 위해 “복구 시점”을 명확히 정하고, 그 시점의 상태와 입력 위치를 함께 기록합니다. 그래서 장애 이후에는 “체크포인트 시점으로 되돌아가 다시 실행”하더라도, 결과가 장애가 없었던 실행과 동일한 의미론을 갖도록 만들 수 있습니다.

## CheckPoint & SavePoint



TODO
1. Task 일관성 그림 예시
2. 내부 상태 일관성만 보장, 외부는 보장 X
